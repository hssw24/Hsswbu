<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buttons Manager</title>
  <style>
    /* Einfaches, mobilfreundliches Layout */
    body { font-family: Arial, sans-serif; padding:16px; max-width:640px; margin:auto; }
    h3 { margin-top:0; }
    .controls { display:flex; gap:8px; margin-bottom:12px; }
    input { flex:1; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
    button { padding:12px; font-size:16px; border-radius:8px; border:none; background:#0a84ff; color:#fff; }
    #list { display:flex; flex-direction:column; gap:10px; }
    .item {
      background:#007aff; color:#fff; padding:14px; border-radius:10px;
      display:flex; justify-content:space-between; align-items:center; font-size:16px;
      touch-action:manipulation;
    }
    .small { background:#ff3b30; padding:8px 10px; border-radius:8px; color:#fff; cursor:pointer; }
    .label { flex:1; margin-right:10px; word-break:break-word; }
  </style>
</head>
<body>
  <h3>Buttons Manager</h3>

  <div class="controls">
    <input id="label" placeholder="Beschriftung" /><br>
    <input id="link" placeholder="https://..." /><p>
    <button id="add">Hinzufügen</button></p>
  </div>

  <div id="list"></div>

  <!-- SortableJS (Touch-freundlich) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- Firebase v9 modular (CDN) -->
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc,
      query, orderBy, getDoc, getDocs, limit
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- ERSETZE mit deinen Firebase-Projektdaten ---
    const firebaseConfig = {
    apiKey: "AIzaSyAXAKrNc6ZoLEKXlnmzbVNoIgTB1U94vEs",
    authDomain: "hsswbu-b556d.firebaseapp.com",
    projectId: "hsswbu-b556d",
      // restliche Felder falls vorhanden
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Anonyme Anmeldung, damit Firestore-Regeln mit request.auth != null funktionieren
    signInAnonymously(auth).catch(e => console.warn('Anon sign-in failed', e));

    // DOM-Elemente
    const listEl = document.getElementById('list');
    const labelIn = document.getElementById('label');
    const linkIn = document.getElementById('link');
    const addBtn = document.getElementById('add');

    // Hilfsfunktion: Erstelle ein DOM-Element für einen Button
    function createItemElement(id, data) {
      const el = document.createElement('div');
      el.className = 'item';
      el.dataset.id = id;
      el.innerHTML = `
        <div class="label" role="button" tabindex="0">${escapeHtml(data.label)}</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="small" data-action="open">Öffnen</div>
          <div class="small" data-action="delete">Löschen</div>
        </div>`;
      // Öffnen in neuem Tab
      el.querySelector('[data-action="open"]').onclick = () => window.open(data.url, '_blank');
      // Löschen
      el.querySelector('[data-action="delete"]').onclick = async () => {
        if (!confirm('Löschen?')) return;
        await deleteDoc(doc(db, 'buttons', id));
      };
      return el;
    }

    // Escape für einfache XSS-Vermeidung in diesem Beispiel
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Hinzufügen eines neuen Buttons so, dass er oben erscheint
    addBtn.onclick = async () => {
      const label = labelIn.value.trim();
      const url = linkIn.value.trim();
      if (!label || !url) return alert('Bitte Beschriftung und Link eingeben');

      try {
        // 1) Finde das kleinste vorhandene position-Feld (aufsteigend sortiert, limit 1)
        const qMin = query(collection(db, 'buttons'), orderBy('position', 'asc'), limit(1));
        const snap = await getDocs(qMin);
        let newPosition;
        if (snap.empty) {
          // Keine Einträge: setze Position auf 0
          newPosition = 0;
        } else {
          // Existierender kleinster Wert minus 1 => neues Element oben
          const docMin = snap.docs[0];
          const minPos = docMin.data().position ?? 0;
          newPosition = minPos - 1;
        }

        // 2) Neues Dokument mit position = newPosition anlegen
        await addDoc(collection(db, 'buttons'), { label, url, position: newPosition });
        labelIn.value = ''; linkIn.value = '';
      } catch (err) {
        console.error('Fehler beim Hinzufügen', err);
        alert('Fehler beim Hinzufügen. Schau in die Konsole.');
      }
    };

    // Echtzeit-Listener: Buttons nach position sortiert anzeigen
    const q = query(collection(db, 'buttons'), orderBy('position'));
    onSnapshot(q, snapshot => {
      // Leere Liste und neu aufbauen
      listEl.innerHTML = '';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const el = createItemElement(id, data);
        listEl.appendChild(el);
      });
      // Sortable initialisieren oder neu verbinden
      initSortable();
    });

    // Sortable-Instanz (wird einmalig initialisiert)
    let sortable = null;
    function initSortable() {
      if (sortable) {
        sortable.destroy();
        sortable = null;
      }
      // eslint-disable-next-line no-undef
      sortable = new Sortable(listEl, {
        animation: 150,
        handle: '.label', // Ziehen über Label
        onEnd: async (evt) => {
          // Nach dem Verschieben: neue Reihenfolge aus DOM auslesen
          const children = Array.from(listEl.children);
          try {
            for (let i = 0; i < children.length; i++) {
              const id = children[i].dataset.id;
              const ref = doc(db, 'buttons', id);
              // Setze position auf i (0 = oben)
              await updateDoc(ref, { position: i });
            }
          } catch (err) {
            console.error('Fehler beim Speichern der Reihenfolge', err);
            alert('Fehler beim Speichern der Reihenfolge. Schau in die Konsole.');
          }
        }
      });
    }

  </script>
</body>
</html>
